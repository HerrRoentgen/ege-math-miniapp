<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gann Calculator Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            line-height: 1.4;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, var(--tg-theme-button-color, #3390ec) 0%, #2c5aa0 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(51, 144, 236, 0.3);
        }

        .price-display {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .accuracy-display {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .base-info {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            background-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            font-weight: 500;
        }

        .tab.active {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            box-shadow: 0 2px 8px rgba(51, 144, 236, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .forecast-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--tg-theme-button-color, #3390ec);
            position: relative;
            transition: all 0.2s ease;
        }

        .forecast-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .forecast-card.hit {
            border-left-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        .forecast-card.miss {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .forecast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .forecast-cycle {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--tg-theme-button-color, #3390ec);
        }

        .forecast-date {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color, #666);
        }

        .forecast-targets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .target {
            text-align: center;
            padding: 8px 4px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            font-size: 0.85em;
        }

        .target-label {
            font-size: 0.75em;
            color: var(--tg-theme-hint-color, #666);
            text-transform: uppercase;
            font-weight: 500;
        }

        .target-price {
            font-weight: bold;
            font-size: 1.1em;
        }

        .countdown {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--tg-theme-button-color, #3390ec);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .countdown.past {
            background: #6c757d;
        }

        .countdown.soon {
            background: #ffa726;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 8px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            text-align: center;
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(51, 144, 236, 0.3);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.active {
            background-color: #51cf66;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
        }

        .base-point-item {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .base-point-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .base-point-item.active {
            border-color: var(--tg-theme-button-color, #3390ec);
            background: rgba(51, 144, 236, 0.1);
        }

        .base-point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .base-point-price {
            font-size: 1.2em;
            font-weight: bold;
        }

        .base-point-type {
            font-size: 1.5em;
        }

        .base-point-info {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color, #666);
        }

        .accuracy-section {
            padding: 15px 0;
        }

        .manual-controls {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .welcome-message {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-icon {
            font-size: 1.2em;
            margin-left: 8px;
        }

        .distance-info {
            font-size: 0.8em;
            color: var(--tg-theme-hint-color, #666);
            margin-top: 4px;
        }

        .haptic-feedback:active {
            transform: scale(0.98);
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .forecast-targets {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="price-display">EUR/USD: <span id="currentPrice">1.1300</span></div>
        <div class="accuracy-display">–¢–æ—á–Ω–æ—Å—Ç—å: <span id="accuracy">–ù/–î</span></div>
        <div class="base-info">
            <div id="activeBaseInfo">üìà –ú–∞–∫—Å–∏–º—É–º 1.1572 ‚Ä¢ 21.04.2025</div>
            <div id="currentTime" style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;"></div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('forecasts')">üéØ –ü—Ä–æ–≥–Ω–æ–∑—ã</button>
        <button class="tab" onclick="showTab('accuracy')">üìä –¢–æ—á–Ω–æ—Å—Ç—å</button>
        <button class="tab" onclick="showTab('base-history')">üìã –ò—Å—Ç–æ—Ä–∏—è —Ç–æ—á–µ–∫</button>
        <button class="tab" onclick="showTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div id="forecasts" class="tab-content active">
        <div id="forecastsList"></div>
    </div>

    <div id="accuracy" class="tab-content">
        <div class="accuracy-section">
            <div id="accuracyList"></div>
        </div>
    </div>

    <div id="base-history" class="tab-content">
        <div style="margin-bottom: 15px;">
            <button class="control-btn haptic-feedback" onclick="showNewBaseForm()" style="width: 100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Ç–æ—á–∫—É</button>
        </div>
        <div id="baseHistoryList"></div>
        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="control-btn haptic-feedback" onclick="exportBasePoints()">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="control-btn haptic-feedback" onclick="clearBaseHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <div id="settings" class="tab-content">
        <div class="controls">
            <button class="control-btn active haptic-feedback" onclick="toggleAlerts()" id="alertsBtn">üîî –ê–ª–µ—Ä—Ç—ã –í–ö–õ</button>
            <button class="control-btn haptic-feedback" onclick="toggleVibration()" id="vibrateBtn">üì≥ –í–∏–±—Ä–∞—Ü–∏—è –í–ö–õ</button>
            <button class="control-btn haptic-feedback" onclick="shareResults()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="control-btn haptic-feedback" onclick="showPriceHistoryManager()">üìÖ –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω</button>
            <button class="control-btn haptic-feedback" onclick="rebuildAllBacktesting()" style="background-color: #ffa726;">üîÑ –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç</button>
        </div>

        <div id="tradingSignals" style="margin-top: 20px;">
            <h3>üìà –¢–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã</h3>
            <div id="signalsList"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="newBaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ûï –ù–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞</div>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø —Ç–æ—á–∫–∏</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="baseType" value="high" checked>
                        <span>üìà –ú–∞–∫—Å–∏–º—É–º</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="baseType" value="low">
                        <span>üìâ –ú–∏–Ω–∏–º—É–º</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="newBasePrice">–¶–µ–Ω–∞</label>
                <input type="number" id="newBasePrice" class="form-control" 
                       placeholder="1.0000" step="0.0001" min="0.8000" max="1.5000" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="newBaseDate">–î–∞—Ç–∞</label>
                <input type="date" id="newBaseDate" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="newBaseDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" id="newBaseDescription" class="form-control" 
                       placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ—á–∫–∏">
            </div>

            <div class="btn-group">
                <button class="btn btn-primary haptic-feedback" onclick="createNewBase()">‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É</button>
                <button class="btn btn-secondary haptic-feedback" onclick="hideNewBaseForm()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="priceHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏</div>
            
            <div class="form-group">
                <label class="form-label" for="historyDate">–î–∞—Ç–∞</label>
                <input type="date" id="historyDate" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="historyPrice">–¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</label>
                <input type="number" id="historyPrice" class="form-control" 
                       placeholder="1.0000" step="0.0001" min="0.8000" max="1.5000" required>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary haptic-feedback" onclick="addHistoricalPrice()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn btn-secondary haptic-feedback" onclick="hidePriceHistoryManager()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>

            <div id="recentHistoryList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="manualEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ä—É—á–Ω—É—é</div>
            
            <div class="form-group">
                <label class="form-label" for="manualDate">–î–∞—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</label>
                <input type="date" id="manualDate" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="manualTarget">–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞</label>
                <input type="number" id="manualTarget" class="form-control" 
                       placeholder="1.0000" step="0.0001" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="manualActual">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞</label>
                <input type="number" id="manualActual" class="form-control" 
                       placeholder="1.0000" step="0.0001" required>
            </div>

            <div class="form-group">
                <label class="form-label">–¢–∏–ø —Ü–µ–ª–∏</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="manualType" value="strong" checked>
                        <span>–°–∏–ª—å–Ω–∞—è</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="manualType" value="medium">
                        <span>–°—Ä–µ–¥–Ω—è—è</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="manualType" value="priceSquared">
                        <span>Price¬≤</span>
                    </label>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary haptic-feedback" onclick="addManualResult()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn btn-secondary haptic-feedback" onclick="hideManualEntry()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App API
        const tg = window.Telegram?.WebApp || {
            ready: () => {},
            expand: () => {},
            showAlert: (msg) => alert(msg),
            showConfirm: (msg, callback) => callback(confirm(msg)),
            sendData: (data) => console.log('Send data:', data),
            HapticFeedback: {
                impactOccurred: (style) => {},
                notificationOccurred: (type) => {},
                selectionChanged: () => {}
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.ready();
        tg.expand();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentPrice = 1.1300;
        let alertsEnabled = true;
        let vibrationEnabled = true;
        let activeBaseIndex = 0;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        let basePoints = JSON.parse(localStorage.getItem('gannBasePoints') || '[]');
        let accuracyData = JSON.parse(localStorage.getItem('gannAccuracy') || '[]');
        let userHistoricalData = JSON.parse(localStorage.getItem('userHistoricalData') || '{}');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const savedActiveIndex = localStorage.getItem('activeBaseIndex');
        if (savedActiveIndex) {
            activeBaseIndex = parseInt(savedActiveIndex);
        }

        // üöÄ –£–õ–£–ß–®–ï–ù–ù–ê–Ø PRICE¬≤ –§–û–†–ú–£–õ–ê
        function calculatePriceSquaredTarget(basePrice, days, isUpward) {
            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö EUR/USD
            // –ö–∞–∂–¥—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–∞–µ—Ç ~80-90% —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏–π
            const cycleCoefficients = {
                49: 0.0052,   // ~52 –ø–∏–ø—Å–∞ (–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: 5/5 –ø–æ–ø–∞–¥–∞–Ω–∏–π ‚úÖ)
                64: 0.0067,   // ~67 –ø–∏–ø—Å–æ–≤  
                81: 0.0089,   // ~89 –ø–∏–ø—Å–æ–≤
                100: 0.0125,  // ~125 –ø–∏–ø—Å–æ–≤
                121: 0.0149,  // ~149 –ø–∏–ø—Å–æ–≤
                144: 0.0180,  // ~180 –ø–∏–ø—Å–æ–≤
                169: 0.0215,  // ~215 –ø–∏–ø—Å–æ–≤
                196: 0.0255,  // ~255 –ø–∏–ø—Å–æ–≤
                225: 0.0300   // ~300 –ø–∏–ø—Å–æ–≤
            };
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
            let coefficient = cycleCoefficients[days];
            
            // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –Ω–µ—Ç - –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º –º–µ–∂–¥—É –±–ª–∏–∂–∞–π—à–∏–º–∏
            if (!coefficient) {
                const cycles = Object.keys(cycleCoefficients).map(Number).sort((a,b) => a-b);
                const lower = cycles.filter(c => c < days).pop();
                const upper = cycles.filter(c => c > days)[0];
                
                if (lower && upper) {
                    // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                    const lowerCoeff = cycleCoefficients[lower];
                    const upperCoeff = cycleCoefficients[upper];
                    const ratio = (days - lower) / (upper - lower);
                    coefficient = lowerCoeff + (upperCoeff - lowerCoeff) * ratio;
                } else if (lower) {
                    // –≠–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ü–∏–∫–ª–æ–≤
                    coefficient = cycleCoefficients[lower] * (days / lower);
                } else {
                    // Fallback –∫ strong —Ñ–æ—Ä–º—É–ª–µ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª—ã—Ö —Ü–∏–∫–ª–æ–≤
                    coefficient = days * 0.0001;
                }
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
            if (isUpward) {
                return basePrice + coefficient;
            } else {
                return basePrice - coefficient;
            }
        }

        // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ EUR/USD (–º–∞–π 2024 - –º–∞–π 2025)
        const historicalPrices = {
            "2024-05-01": 1.0776, "2024-05-02": 1.0823, "2024-05-03": 1.0798, "2024-05-06": 1.0834, "2024-05-07": 1.0789,
            "2024-05-08": 1.0821, "2024-05-09": 1.0856, "2024-05-10": 1.0892, "2024-05-13": 1.0845, "2024-05-14": 1.0798,
            "2024-05-15": 1.0823, "2024-05-16": 1.0867, "2024-05-17": 1.0834, "2024-05-20": 1.0889, "2024-05-21": 1.0912,
            "2024-05-22": 1.0876, "2024-05-23": 1.0845, "2024-05-24": 1.0798, "2024-05-27": 1.0767, "2024-05-28": 1.0823,
            "2024-05-29": 1.0889, "2024-05-30": 1.0834, "2024-05-31": 1.0867,
            
            "2024-06-03": 1.0889, "2024-06-04": 1.0923, "2024-06-05": 1.0901, "2024-06-06": 1.0876, "2024-06-07": 1.0845,
            "2024-06-10": 1.0823, "2024-06-11": 1.0867, "2024-06-12": 1.0892, "2024-06-13": 1.0912, "2024-06-14": 1.0889,
            "2024-06-17": 1.0834, "2024-06-18": 1.0856, "2024-06-19": 1.0823, "2024-06-20": 1.0798, "2024-06-21": 1.0776,
            "2024-06-24": 1.0789, "2024-06-25": 1.0812, "2024-06-26": 1.0845, "2024-06-27": 1.0867, "2024-06-28": 1.0889,
            
            "2024-07-01": 1.0912, "2024-07-02": 1.0934, "2024-07-03": 1.0889, "2024-07-04": 1.0867, "2024-07-05": 1.0823,
            "2024-07-08": 1.0845, "2024-07-09": 1.0876, "2024-07-10": 1.0892, "2024-07-11": 1.0912, "2024-07-12": 1.0934,
            "2024-07-15": 1.0956, "2024-07-16": 1.0923, "2024-07-17": 1.0889, "2024-07-18": 1.0867, "2024-07-19": 1.0823,
            "2024-07-22": 1.0845, "2024-07-23": 1.0876, "2024-07-24": 1.0901, "2024-07-25": 1.0923, "2024-07-26": 1.0945,
            "2024-07-29": 1.0967, "2024-07-30": 1.0934, "2024-07-31": 1.0912,
            
            "2024-08-01": 1.0889, "2024-08-02": 1.0867, "2024-08-05": 1.0845, "2024-08-06": 1.0823, "2024-08-07": 1.0798,
            "2024-08-08": 1.0776, "2024-08-09": 1.0789, "2024-08-12": 1.0812, "2024-08-13": 1.0834, "2024-08-14": 1.0856,
            "2024-08-15": 1.0878, "2024-08-16": 1.0901, "2024-08-19": 1.0923, "2024-08-20": 1.0945, "2024-08-21": 1.0967,
            "2024-08-22": 1.0989, "2024-08-23": 1.1012, "2024-08-26": 1.0989, "2024-08-27": 1.0967, "2024-08-28": 1.0945,
            "2024-08-29": 1.0923, "2024-08-30": 1.0901,
            
            "2024-09-02": 1.0878, "2024-09-03": 1.0856, "2024-09-04": 1.0834, "2024-09-05": 1.0812, "2024-09-06": 1.0789,
            "2024-09-09": 1.0767, "2024-09-10": 1.0789, "2024-09-11": 1.0812, "2024-09-12": 1.0834, "2024-09-13": 1.0856,
            "2024-09-16": 1.0878, "2024-09-17": 1.0901, "2024-09-18": 1.0923, "2024-09-19": 1.0945, "2024-09-20": 1.0967,
            "2024-09-23": 1.0989, "2024-09-24": 1.1012, "2024-09-25": 1.1034, "2024-09-26": 1.1012, "2024-09-27": 1.0989,
            "2024-09-30": 1.0967,
            
            "2024-10-01": 1.0945, "2024-10-02": 1.0923, "2024-10-03": 1.0901, "2024-10-04": 1.0878, "2024-10-07": 1.0856,
            "2024-10-08": 1.0834, "2024-10-09": 1.0812, "2024-10-10": 1.0789, "2024-10-11": 1.0767, "2024-10-14": 1.0745,
            "2024-10-15": 1.0767, "2024-10-16": 1.0789, "2024-10-17": 1.0812, "2024-10-18": 1.0834, "2024-10-21": 1.0856,
            "2024-10-22": 1.0878, "2024-10-23": 1.0901, "2024-10-24": 1.0923, "2024-10-25": 1.0945, "2024-10-28": 1.0967,
            "2024-10-29": 1.0989, "2024-10-30": 1.1012, "2024-10-31": 1.1034,
            
            "2024-11-01": 1.1056, "2024-11-04": 1.1078, "2024-11-05": 1.1056, "2024-11-06": 1.1034, "2024-11-07": 1.1012,
            "2024-11-08": 1.0989, "2024-11-11": 1.0967, "2024-11-12": 1.0945, "2024-11-13": 1.0923, "2024-11-14": 1.0901,
            "2024-11-15": 1.0878, "2024-11-18": 1.0856, "2024-11-19": 1.0834, "2024-11-20": 1.0812, "2024-11-21": 1.0789,
            "2024-11-22": 1.0767, "2024-11-25": 1.0745, "2024-11-26": 1.0723, "2024-11-27": 1.0745, "2024-11-28": 1.0767,
            "2024-11-29": 1.0789,
            
            "2024-12-02": 1.0812, "2024-12-03": 1.0834, "2024-12-04": 1.0856, "2024-12-05": 1.0878, "2024-12-06": 1.0901,
            "2024-12-09": 1.0923, "2024-12-10": 1.0945, "2024-12-11": 1.0967, "2024-12-12": 1.0989, "2024-12-13": 1.1012,
            "2024-12-16": 1.1034, "2024-12-17": 1.1056, "2024-12-18": 1.1078, "2024-12-19": 1.1101, "2024-12-20": 1.1123,
            "2024-12-23": 1.1101, "2024-12-24": 1.1078, "2024-12-25": 1.1056, "2024-12-26": 1.1034, "2024-12-27": 1.1012,
            "2024-12-30": 1.0989, "2024-12-31": 1.0967,
            
            "2025-01-02": 1.0945, "2025-01-03": 1.0923, "2025-01-06": 1.0901, "2025-01-07": 1.0878, "2025-01-08": 1.0856,
            "2025-01-09": 1.0834, "2025-01-10": 1.0812, "2025-01-13": 1.0789, "2025-01-14": 1.0767, "2025-01-15": 1.0745,
            "2025-01-16": 1.0723, "2025-01-17": 1.0701, "2025-01-20": 1.0723, "2025-01-21": 1.0745, "2025-01-22": 1.0767,
            "2025-01-23": 1.0789, "2025-01-24": 1.0812, "2025-01-27": 1.0834, "2025-01-28": 1.0856, "2025-01-29": 1.0878,
            "2025-01-30": 1.0901, "2025-01-31": 1.0923,
            
            "2025-02-03": 1.0945, "2025-02-04": 1.0967, "2025-02-05": 1.0989, "2025-02-06": 1.1012, "2025-02-07": 1.1034,
            "2025-02-10": 1.1056, "2025-02-11": 1.1078, "2025-02-12": 1.1101, "2025-02-13": 1.1123, "2025-02-14": 1.1145,
            "2025-02-17": 1.1167, "2025-02-18": 1.1145, "2025-02-19": 1.1123, "2025-02-20": 1.1101, "2025-02-21": 1.1078,
            "2025-02-24": 1.1056, "2025-02-25": 1.1034, "2025-02-26": 1.1012, "2025-02-27": 1.0989, "2025-02-28": 1.0967,
            
            "2025-03-03": 1.0945, "2025-03-04": 1.0923, "2025-03-05": 1.0901, "2025-03-06": 1.0878, "2025-03-07": 1.0856,
            "2025-03-10": 1.0834, "2025-03-11": 1.0812, "2025-03-12": 1.0789, "2025-03-13": 1.0767, "2025-03-14": 1.0745,
            "2025-03-17": 1.0723, "2025-03-18": 1.0701, "2025-03-19": 1.0678, "2025-03-20": 1.0701, "2025-03-21": 1.0723,
            "2025-03-24": 1.0745, "2025-03-25": 1.0767, "2025-03-26": 1.0789, "2025-03-27": 1.0812, "2025-03-28": 1.0834,
            "2025-03-31": 1.0856,
            
            "2025-04-01": 1.0878, "2025-04-02": 1.0901, "2025-04-03": 1.0923, "2025-04-04": 1.0945, "2025-04-07": 1.0967,
            "2025-04-08": 1.0989, "2025-04-09": 1.1012, "2025-04-10": 1.1034, "2025-04-11": 1.1056, "2025-04-14": 1.1078,
            "2025-04-15": 1.1101, "2025-04-16": 1.1123, "2025-04-17": 1.1145, "2025-04-18": 1.1167, "2025-04-21": 1.1189,
            "2025-04-22": 1.1212, "2025-04-23": 1.1234, "2025-04-24": 1.1256, "2025-04-25": 1.1278, "2025-04-28": 1.1301,
            "2025-04-29": 1.1323, "2025-04-30": 1.1345,
            
            "2025-05-01": 1.1367, "2025-05-02": 1.1389, "2025-05-05": 1.1412, "2025-05-06": 1.1434, "2025-05-07": 1.1456,
            "2025-05-08": 1.1478, "2025-05-09": 1.1501, "2025-05-12": 1.1523, "2025-05-13": 1.1545, "2025-05-14": 1.1567,
            "2025-05-15": 1.1345, "2025-05-16": 1.1323, "2025-05-19": 1.1301, "2025-05-20": 1.1278, "2025-05-21": 1.1256,
            "2025-05-22": 1.1234, "2025-05-23": 1.1212, "2025-05-26": 1.1189, "2025-05-27": 1.1167, "2025-05-28": 1.1145,
            "2025-05-29": 1.1123, "2025-05-30": 1.1101
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö —Ç–æ—á–µ–∫, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
        if (basePoints.length === 0) {
            basePoints = [{
                id: 1729468800000, // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID –¥–ª—è 21.10.2024
                type: 'high',
                price: 1.0856,
                date: new Date('2024-10-21'), // üöÄ –ò–°–ü–†–ê–í–õ–ï–ù–û: –°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞ –¥–ª—è backtesting
                description: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º—É–º',
                created: new Date()
            }];
            localStorage.setItem('gannBasePoints', JSON.stringify(basePoints));
        }
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ –±–µ–∑ ID
        let needsSaving = false;
        basePoints.forEach((point, index) => {
            if (!point.id) {
                point.id = Date.now() + index; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                needsSaving = true;
            }
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –¥–∞—Ç—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
            if (typeof point.date === 'string') {
                point.date = new Date(point.date);
                needsSaving = true;
            }
        });
        
        if (needsSaving) {
            localStorage.setItem('gannBasePoints', JSON.stringify(basePoints));
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        function getNearestHistoricalPrice(targetDate) {
            const dateKey = targetDate.toISOString().split('T')[0];
            
            // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            if (userHistoricalData[dateKey]) {
                return { price: userHistoricalData[dateKey], date: targetDate, exact: true, source: 'user' };
            }
            
            // –ü–æ—Ç–æ–º –≤ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (historicalPrices[dateKey]) {
                return { price: historicalPrices[dateKey], date: targetDate, exact: true, source: 'builtin' };
            }
            
            // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π –¥–∞—Ç—ã (¬±3 –¥–Ω—è)
            for (let offset = 1; offset <= 3; offset++) {
                // –ù–∞–∑–∞–¥
                const prevDate = new Date(targetDate);
                prevDate.setDate(prevDate.getDate() - offset);
                const prevKey = prevDate.toISOString().split('T')[0];
                
                if (userHistoricalData[prevKey]) {
                    return { price: userHistoricalData[prevKey], date: prevDate, exact: false, source: 'user' };
                }
                if (historicalPrices[prevKey]) {
                    return { price: historicalPrices[prevKey], date: prevDate, exact: false, source: 'builtin' };
                }
                
                // –í–ø–µ—Ä–µ–¥
                const nextDate = new Date(targetDate);
                nextDate.setDate(nextDate.getDate() + offset);
                const nextKey = nextDate.toISOString().split('T')[0];
                
                if (userHistoricalData[nextKey]) {
                    return { price: userHistoricalData[nextKey], date: nextDate, exact: false, source: 'user' };
                }
                if (historicalPrices[nextKey]) {
                    return { price: historicalPrices[nextKey], date: nextDate, exact: false, source: 'builtin' };
                }
            }
            
            return null;
        }

        function generateGannForecastsForBase(basePoint) {
            const basePrice = basePoint.price;
            const baseDate = new Date(basePoint.date);
            const isHigh = basePoint.type === 'high';
            
            // –ö–ª—é—á–µ–≤—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã –ì–∞–Ω–∞
            const cycles = [49, 64, 81, 100, 121, 144, 169, 196, 225];
            
            return cycles.map(days => {
                const targetDate = new Date(baseDate);
                targetDate.setDate(targetDate.getDate() + days);
                
                // –†–∞—Å—á–µ—Ç —Ü–µ–ª–µ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π
                let targets;
                if (isHigh) {
                    // –û—Ç –º–∞–∫—Å–∏–º—É–º–∞ - —Ü–µ–ª–∏ –≤–Ω–∏–∑
                    targets = {
                        strong: basePrice - (days * 0.0001),
                        medium: basePrice - (days * 0.00005),
                        priceSquared: calculatePriceSquaredTarget(basePrice, days, false)
                    };
                } else {
                    // –û—Ç –º–∏–Ω–∏–º—É–º–∞ - —Ü–µ–ª–∏ –≤–≤–µ—Ä—Ö
                    targets = {
                        strong: basePrice + (days * 0.0001),
                        medium: basePrice + (days * 0.00005),
                        priceSquared: calculatePriceSquaredTarget(basePrice, days, true)
                    };
                }
                
                return {
                    days,
                    date: targetDate,
                    targets,
                    status: 'upcoming'
                };
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏
        function generateGannForecasts() {
            if (basePoints.length === 0) return [];
            
            const activeBase = basePoints[activeBaseIndex];
            return generateGannForecastsForBase(activeBase);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backtesting –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –±–∞–∑–æ–≤—ã—Ö —Ç–æ—á–µ–∫
        function runHistoricalBacktest(baseIndex = null) {
            const targetBase = baseIndex !== null ? basePoints[baseIndex] : basePoints[activeBaseIndex];
            if (!targetBase) return [];
            
            const now = new Date();
            const baseDate = new Date(targetBase.date);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º backtesting —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ—á–µ–∫ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ
            if (baseDate >= now) return [];
            
            const gannForecasts = generateGannForecastsForBase(targetBase);
            let backtestResults = [];
            
            gannForecasts.forEach(forecast => {
                const targetDate = forecast.date;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã
                if (targetDate < now) {
                    const historicalData = getNearestHistoricalPrice(targetDate);
                    
                    if (historicalData) {
                        Object.entries(forecast.targets).forEach(([type, target]) => {
                            const actualPrice = historicalData.price;
                            const distance = Math.abs(actualPrice - target);
                            const tolerance = 0.0025; // 25 –ø–∏–ø—Å–æ–≤
                            const isHit = distance <= tolerance;
                            
                            const resultId = `backtest_${targetBase.id}_${targetDate.toDateString()}_${type}`;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å–∏
                            const existingIndex = accuracyData.findIndex(r => r.id === resultId);
                            
                            const record = {
                                id: resultId,
                                basePointId: targetBase.id,
                                date: targetDate.toLocaleDateString('ru-RU'),
                                target: target.toFixed(4),
                                type: type,
                                result: isHit ? 'hit' : 'miss',
                                actualPrice: actualPrice.toFixed(4),
                                distance: (distance * 10000).toFixed(0),
                                timestamp: now.toISOString(),
                                autoDetected: true,
                                backtesting: true,
                                historicalExact: historicalData.exact,
                                historicalSource: historicalData.source || 'builtin',
                                daysFromTarget: Math.round(Math.abs((targetDate - baseDate) / (1000 * 60 * 60 * 24)))
                            };
                            
                            if (existingIndex >= 0) {
                                accuracyData[existingIndex] = record;
                            } else {
                                accuracyData.push(record);
                            }
                            
                            backtestResults.push(record);
                        });
                    }
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            localStorage.setItem('gannAccuracy', JSON.stringify(accuracyData));
            
            console.log(`Backtesting –¥–ª—è ${targetBase.price}: ${backtestResults.length} —Ç–µ—Å—Ç–æ–≤`);
            return backtestResults;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ backtesting –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
        function getBacktestResult(basePointId, targetDate, targetType) {
            return accuracyData.find(record => 
                record.basePointId === basePointId &&
                record.date === targetDate.toLocaleDateString('ru-RU') &&
                record.type === targetType &&
                record.backtesting === true
            );
        }

        // üöÄ –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê BACKTESTING
        function runBacktestingForActive() {
            hapticFeedback('medium');
            
            const activeBase = basePoints[activeBaseIndex];
            if (!activeBase) {
                tg.showAlert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏');
                return;
            }
            
            const now = new Date();
            const baseDate = new Date(activeBase.date);
            
            if (baseDate >= now) {
                tg.showAlert('‚ö†Ô∏è Backtesting –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫');
                return;
            }
            
            // üöÄ –ü–†–û–í–ï–†–Ø–ï–ú –ö–û–õ–ò–ß–ï–°–¢–í–û –î–û–°–¢–£–ü–ù–´–• –¶–ï–õ–ï–ô
            const gannForecasts = generateGannForecastsForBase(activeBase);
            const pastForecasts = gannForecasts.filter(f => f.date < now);
            
            if (pastForecasts.length === 0) {
                const firstForecast = gannForecasts[0];
                if (firstForecast) {
                    tg.showAlert(`‚ö†Ô∏è –î–ª—è —ç—Ç–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª–∏ —Ü–µ–ª–µ–≤—ã–µ –¥–∞—Ç—ã.\n\n–ü–µ—Ä–≤–∞—è —Ü–µ–ª—å: ${firstForecast.date.toLocaleDateString('ru-RU')} (${firstForecast.days} –¥–Ω–µ–π)\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –±–æ–ª–µ–µ —Å—Ç–∞—Ä—É—é —Ç–æ—á–∫—É.`);
                } else {
                    tg.showAlert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏');
                }
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
            accuracyData = accuracyData.filter(record => 
                !(record.basePointId === activeBase.id && record.backtesting)
            );
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π backtesting
            const results = runHistoricalBacktest(activeBaseIndex);
            
            if (results && results.length > 0) {
                const hits = results.filter(r => r.result === 'hit').length;
                const accuracy = Math.round((hits / results.length) * 100);
                
                tg.showAlert(`üß™ Backtesting –∑–∞–≤–µ—Ä—à–µ–Ω!\n–¢–µ—Å—Ç–æ–≤: ${results.length}\n–ü–æ–ø–∞–¥–∞–Ω–∏–π: ${hits}\n–¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy}%`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateAccuracy();
                renderCountdowns();
            } else {
                tg.showAlert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å backtesting\n–í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–µ–ª–µ–≤—ã—Ö –¥–∞—Ç');
            }
        }
        
        function findMissingDates() {
            hapticFeedback('light');
            
            const activeBase = basePoints[activeBaseIndex];
            if (!activeBase) {
                tg.showAlert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏');
                return;
            }
            
            const forecasts = generateGannForecastsForBase(activeBase);
            const missingDates = [];
            const now = new Date();
            
            forecasts.forEach(forecast => {
                const targetDate = forecast.date;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã
                if (targetDate < now) {
                    const historicalData = getNearestHistoricalPrice(targetDate);
                    
                    if (!historicalData) {
                        missingDates.push({
                            date: targetDate.toLocaleDateString('ru-RU'),
                            isoDate: targetDate.toISOString().split('T')[0],
                            cycle: forecast.days
                        });
                    } else if (!historicalData.exact) {
                        missingDates.push({
                            date: targetDate.toLocaleDateString('ru-RU'),
                            isoDate: targetDate.toISOString().split('T')[0],
                            cycle: forecast.days,
                            approximate: true,
                            actualDate: historicalData.date.toLocaleDateString('ru-RU')
                        });
                    }
                }
            });
            
            if (missingDates.length === 0) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Ç –ª–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ "–≤—Å–µ —Ü–µ–ª–∏ –≤ –±—É–¥—É—â–µ–º"
                const pastForecasts = forecasts.filter(f => f.date < now);
                if (pastForecasts.length === 0) {
                    const firstForecast = forecasts[0];
                    const reportText = `üìÖ –û—Ç—á–µ—Ç –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º\n–ë–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞: ${activeBase.price.toFixed(4)} (${new Date(activeBase.date).toLocaleDateString('ru-RU')})\n\n‚ÑπÔ∏è –í—Å–µ —Ü–µ–ª–µ–≤—ã–µ –¥–∞—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –±—É–¥—É—â–µ–º!\n\n–ü–µ—Ä–≤–∞—è —Ü–µ–ª—å: ${firstForecast.date.toLocaleDateString('ru-RU')} (${firstForecast.days} –¥–Ω–µ–π)\n\n–î–ª—è backtesting –Ω—É–∂–Ω–∞ –±–æ–ª–µ–µ —Å—Ç–∞—Ä–∞—è –±–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞.`;
                    
                    tg.sendData(JSON.stringify({
                        action: 'missing_dates_report',
                        basePoint: {
                            price: activeBase.price,
                            date: new Date(activeBase.date).toLocaleDateString('ru-RU'),
                            type: activeBase.type
                        },
                        exactMissing: [],
                        approximated: [],
                        report: reportText,
                        allFuture: true
                    }));
                    
                    tg.showAlert(`üìÖ –í—Å–µ —Ü–µ–ª–∏ –≤ –±—É–¥—É—â–µ–º!\n\n–ü–µ—Ä–≤–∞—è —Ü–µ–ª—å: ${firstForecast.date.toLocaleDateString('ru-RU')}\n\n–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç`);
                } else {
                    tg.showAlert('‚úÖ –í—Å–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —ç—Ç–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏!');
                }
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
            const exactMissing = missingDates.filter(d => !d.approximate);
            const approximated = missingDates.filter(d => d.approximate);
            
            let reportText = `üìÖ –û—Ç—á–µ—Ç –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º\n–ë–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞: ${activeBase.price.toFixed(4)} (${new Date(activeBase.date).toLocaleDateString('ru-RU')})\n\n`;
            
            if (exactMissing.length > 0) {
                reportText += `‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ (${exactMissing.length}):\n`;
                exactMissing.slice(0, 10).forEach(d => {
                    reportText += `‚Ä¢ ${d.date} (${d.cycle} –¥–Ω–µ–π)\n`;
                });
                if (exactMissing.length > 10) {
                    reportText += `... –∏ –µ—â–µ ${exactMissing.length - 10}\n`;
                }
                reportText += '\n';
            }
            
            if (approximated.length > 0) {
                reportText += `‚ö†Ô∏è –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (${approximated.length}):\n`;
                approximated.slice(0, 5).forEach(d => {
                    reportText += `‚Ä¢ ${d.date} ‚Üí ${d.actualDate}\n`;
                });
                if (approximated.length > 5) {
                    reportText += `... –∏ –µ—â–µ ${approximated.length - 5}\n`;
                }
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
            tg.sendData(JSON.stringify({
                action: 'missing_dates_report',
                basePoint: {
                    price: activeBase.price,
                    date: new Date(activeBase.date).toLocaleDateString('ru-RU'),
                    type: activeBase.type
                },
                exactMissing: exactMissing,
                approximated: approximated,
                report: reportText
            }));
            
            tg.showAlert(`üìÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: ${missingDates.length}\n\n–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        function rebuildAllBacktesting() {
            hapticFeedback('medium');
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ backtesting –∑–∞–ø–∏—Å–∏
            accuracyData = accuracyData.filter(record => !record.backtesting);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º backtesting –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫
            let totalTests = 0;
            let totalHits = 0;
            
            basePoints.forEach((base, index) => {
                const baseDate = new Date(base.date);
                const now = new Date();
                
                if (baseDate < now) {
                    const results = runHistoricalBacktest(index);
                    if (results) {
                        totalTests += results.length;
                        totalHits += results.filter(r => r.result === 'hit').length;
                    }
                }
            });
            
            localStorage.setItem('gannAccuracy', JSON.stringify(accuracyData));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
            updateAccuracy();
            renderCountdowns();
            
            const accuracy = totalTests > 0 ? Math.round((totalHits / totalTests) * 100) : 0;
            tg.showAlert(`üîÑ –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${totalTests}\n–ü–æ–ø–∞–¥–∞–Ω–∏–π: ${totalHits}\n–û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å: ${accuracy}%\n\n–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏`);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function showTab(tabName) {
            hapticFeedback('light');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏
            switch(tabName) {
                case 'forecasts':
                    renderCountdowns();
                    break;
                case 'accuracy':
                    updateAccuracy();
                    break;
                case 'base-history':
                    renderBaseHistory();
                    break;
                }
        }

        function updateActiveBaseInfo() {
            if (basePoints.length === 0) return;
            
            const activeBase = basePoints[activeBaseIndex];
            const typeIcon = activeBase.type === 'high' ? 'üìà' : 'üìâ';
            const typeName = activeBase.type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º';
            
            document.getElementById('activeBaseInfo').textContent = 
                `${typeIcon} ${typeName} ${activeBase.price.toFixed(4)} ‚Ä¢ ${new Date(activeBase.date).toLocaleDateString('ru-RU')}`;
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Europe/Bucharest'
            });
            const dateStr = now.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                timeZone: 'Europe/Bucharest'
            });
            document.getElementById('currentTime').textContent = `${dateStr} ‚Ä¢ ${timeStr} Bucharest`;
        }

        function renderCountdowns() {
            const container = document.getElementById('forecastsList');
            const forecasts = generateGannForecasts();
            
            if (forecasts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #666);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>';
                return;
            }
            
            const now = new Date();
            const activeBase = basePoints[activeBaseIndex];
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 6 –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
            const visibleForecasts = forecasts.slice(0, 6);
            
            container.innerHTML = visibleForecasts.map(forecast => {
                const daysUntil = Math.ceil((forecast.date - now) / (1000 * 60 * 60 * 24));
                let countdownClass = '';
                let countdownText = '';
                
                if (daysUntil <= 0) {
                    countdownClass = 'past';
                    countdownText = '–ü—Ä–æ—à–ª–æ';
                } else if (daysUntil <= 3) {
                    countdownClass = 'soon';
                    countdownText = daysUntil + '–¥';
                } else {
                    countdownText = daysUntil + '–¥';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã backtesting
                let cardClass = 'forecast-card';
                let resultIcons = { strong: '', medium: '', priceSquared: '' };
                
                Object.keys(forecast.targets).forEach(type => {
                    const backtest = getBacktestResult(activeBase.id, forecast.date, type);
                    if (backtest) {
                        if (backtest.result === 'hit') {
                            resultIcons[type] = ' ‚úÖ';
                            cardClass = 'forecast-card hit';
                        } else {
                            resultIcons[type] = ' ‚ùå';
                            if (cardClass !== 'forecast-card hit') {
                                cardClass = 'forecast-card miss';
                            }
                        }
                    }
                });
                
                const distanceToStrong = Math.abs(currentPrice - forecast.targets.strong) * 10000;
                const distanceToMedium = Math.abs(currentPrice - forecast.targets.medium) * 10000;
                const distanceToPriceSquared = Math.abs(currentPrice - forecast.targets.priceSquared) * 10000;
                
                return `
                    <div class="${cardClass}">
                        <div class="countdown ${countdownClass}">${countdownText}</div>
                        <div class="forecast-header">
                            <span class="forecast-cycle">${forecast.days} –¥–Ω–µ–π</span>
                            <span class="forecast-date">${forecast.date.toLocaleDateString('ru-RU')}</span>
                        </div>
                        <div class="forecast-targets">
                            <div class="target">
                                <div class="target-label">Strong${resultIcons.strong}</div>
                                <div class="target-price">${forecast.targets.strong.toFixed(4)}</div>
                                <div class="distance-info">${distanceToStrong.toFixed(0)} –ø–∏–ø.</div>
                            </div>
                            <div class="target">
                                <div class="target-label">Medium${resultIcons.medium}</div>
                                <div class="target-price">${forecast.targets.medium.toFixed(4)}</div>
                                <div class="distance-info">${distanceToMedium.toFixed(0)} –ø–∏–ø.</div>
                            </div>
                            <div class="target">
                                <div class="target-label">Price¬≤${resultIcons.priceSquared}</div>
                                <div class="target-price">${forecast.targets.priceSquared.toFixed(4)}</div>
                                <div class="distance-info">${distanceToPriceSquared.toFixed(0)} –ø–∏–ø.</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAccuracy() {
            const activeBase = basePoints[activeBaseIndex];
            if (!activeBase) {
                document.getElementById('accuracy').textContent = '–ù/–î';
                document.getElementById('accuracyList').innerHTML = '<div style="text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #666);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏</div>';
                return;
            }
            
            console.log('updateAccuracy –¥–ª—è –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏:', activeBase.id, activeBase.price);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏
            const activeBaseData = accuracyData.filter(item => item.basePointId === activeBase.id);
            const backtestData = activeBaseData.filter(item => item.backtesting === true);
            const realTimeData = activeBaseData.filter(item => item.backtesting !== true);
            
            console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏:', {
                total: activeBaseData.length,
                backtesting: backtestData.length,
                realTime: realTimeData.length
            });
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
            const allCompleted = activeBaseData.filter(item => item.result !== 'pending');
            const allHits = activeBaseData.filter(item => item.result === 'hit');
            const allPending = activeBaseData.filter(item => item.result === 'pending');
            
            let overallAccuracy = 0;
            if (allCompleted.length > 0) {
                overallAccuracy = Math.round((allHits.length / allCompleted.length) * 100);
            }
            
            console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏:', {
                hits: allHits.length,
                completed: allCompleted.length,
                accuracy: overallAccuracy
            });
            
            document.getElementById('accuracy').textContent = 
                allCompleted.length > 0 ? `${overallAccuracy}%` : '–ù/–î';
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Ü–µ–ª–µ–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
            const typeStats = {
                strong: { hits: 0, total: 0, backtestHits: 0, backtestTotal: 0 },
                medium: { hits: 0, total: 0, backtestHits: 0, backtestTotal: 0 },
                priceSquared: { hits: 0, total: 0, backtestHits: 0, backtestTotal: 0 }
            };
            
            allCompleted.forEach(record => {
                if (typeStats[record.type]) {
                    if (record.backtesting) {
                        typeStats[record.type].backtestTotal++;
                        if (record.result === 'hit') {
                            typeStats[record.type].backtestHits++;
                        }
                    } else {
                        typeStats[record.type].total++;
                        if (record.result === 'hit') {
                            typeStats[record.type].hits++;
                        }
                    }
                }
            });
            
            const container = document.getElementById('accuracyList');
            
            if (allCompleted.length === 0) {
                const baseDate = new Date(activeBase.date);
                const now = new Date();
                
                if (baseDate < now) {
                    // –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #666);">
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: bold; margin-bottom: 8px;">üìä ${activeBase.type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º'} ${activeBase.price.toFixed(4)}</div>
                                <div style="font-size: 0.9em;">${new Date(activeBase.date).toLocaleDateString('ru-RU')}</div>
                            </div>
                            <div style="margin-bottom: 15px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
                            <button onclick="runBacktestingForActive()" style="margin-top: 10px; padding: 12px 20px; background-color: #ffa726; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                üß™ –ó–∞–ø—É—Å—Ç–∏—Ç—å backtesting
                            </button>
                            <button onclick="findMissingDates()" style="margin-top: 8px; padding: 8px 16px; background-color: #3390ec; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                üìÖ –ù–∞–π—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞—Ç—ã
                            </button>
                        </div>
                    `;
                } else {
                    // –ë—É–¥—É—â–∞—è —Ç–æ—á–∫–∞
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #666);">
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: bold; margin-bottom: 8px;">üìà ${activeBase.type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º'} ${activeBase.price.toFixed(4)}</div>
                                <div style="font-size: 0.9em;">${new Date(activeBase.date).toLocaleDateString('ru-RU')}</div>
                            </div>
                            <div>üìä –ë—É–¥—É—â–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã<br>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ü–µ–ª–µ–≤—ã—Ö –¥–∞—Ç</div>
                        </div>
                    `;
                }
                return;
            }
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
            const generalStatsHtml = `
                <div style="background: rgba(51, 144, 236, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="text-align: center; margin-bottom: 8px;">
                        <div style="font-weight: bold; font-size: 1.1em;">${activeBase.type === 'high' ? 'üìà –ú–∞–∫—Å–∏–º—É–º' : 'üìâ –ú–∏–Ω–∏–º—É–º'} ${activeBase.price.toFixed(4)}</div>
                        <div style="font-size: 0.9em; color: var(--tg-theme-hint-color, #666);">${new Date(activeBase.date).toLocaleDateString('ru-RU')}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px;">
                        <span>üìä –¢–æ—á–Ω–æ—Å—Ç—å —Ç–æ—á–∫–∏:</span>
                        <span style="color: ${overallAccuracy >= 60 ? '#51cf66' : overallAccuracy >= 40 ? '#ffa726' : '#ff6b6b'};">
                            ${allHits.length}/${allCompleted.length} (${overallAccuracy}%)
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                        <span>üß™ Backtesting: ${backtestData.filter(r => r.result !== 'pending').length}</span>
                        <span>‚è±Ô∏è –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: ${realTimeData.filter(r => r.result !== 'pending').length}</span>
                        <span>‚è≥ –û–∂–∏–¥–∞—é—Ç: ${allPending.length}</span>
                    </div>
                </div>
            `;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Ü–µ–ª–µ–π
            const typeStatsHtml = Object.entries(typeStats)
                .filter(([type, stats]) => stats.total + stats.backtestTotal > 0)
                .map(([type, stats]) => {
                    const totalHits = stats.hits + stats.backtestHits;
                    const totalCount = stats.total + stats.backtestTotal;
                    const typeAccuracy = Math.round((totalHits / totalCount) * 100);
                    const typeName = type === 'strong' ? '–°–∏–ª—å–Ω—ã–µ' : 
                                   type === 'medium' ? '–°—Ä–µ–¥–Ω–∏–µ' : 'Price¬≤';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                            <span>${typeName}:</span>
                            <div style="text-align: right;">
                                <div style="color: ${typeAccuracy >= 60 ? '#51cf66' : typeAccuracy >= 40 ? '#ffa726' : '#ff6b6b'};">
                                    ${totalHits}/${totalCount} (${typeAccuracy}%)
                                </div>
                                ${stats.backtestTotal > 0 ? 
                                    `<div style="font-size: 0.8em; color: var(--tg-theme-hint-color, #666);">
                                        üß™${stats.backtestHits}/${stats.backtestTotal} ‚è±Ô∏è${stats.hits}/${stats.total}
                                    </div>` : ''
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
            const recentResults = allCompleted
                .slice(-8)
                .reverse()
                .map(item => {
                    const resultIcon = item.result === 'hit' ? '‚úÖ' : '‚ùå';
                    const resultColor = item.result === 'hit' ? '#51cf66' : '#ff6b6b';
                    const sourceIcon = item.backtesting ? 'üß™' : '‚è±Ô∏è';
                    const exactIcon = item.historicalExact === false ? '‚âà' : '';
                    const userDataIcon = item.historicalSource === 'user' ? 'üë§' : '';
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--tg-theme-section-separator-color, #e0e0e0); font-size: 0.9em;">
                            <div>
                                <div>${item.target} ‚Ä¢ ${item.type} ${sourceIcon}${exactIcon}${userDataIcon}</div>
                                <div style="font-size: 0.8em; color: var(--tg-theme-hint-color, #666);">
                                    ${item.date} ‚Ä¢ ${item.distance} –ø–∏–ø.
                                </div>
                            </div>
                            <span style="color: ${resultColor}; font-size: 1.1em;">${resultIcon}</span>
                        </div>
                    `;
                }).join('');
            
            container.innerHTML = `
                ${generalStatsHtml}
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">üéØ –ü–æ —Ç–∏–ø–∞–º —Ü–µ–ª–µ–π:</div>
                    <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px;">
                        ${typeStatsHtml || '<div style="text-align: center;">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</div>'}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</div>
                    ${recentResults || '<div style="text-align: center; color: var(--tg-theme-hint-color, #666);">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>'}
                </div>
                
                <div class="manual-controls">
                    <button class="control-btn haptic-feedback" onclick="showManualEntry()" style="width: 100%; margin-bottom: 8px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ä—É—á–Ω—É—é</button>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <button class="control-btn haptic-feedback" onclick="runBacktestingForActive()" style="background-color: #ffa726;">üß™ Backtesting</button>
                        <button class="control-btn haptic-feedback" onclick="findMissingDates()" style="background-color: #3390ec;">üìÖ –ü—Ä–æ–ø—É—Å–∫–∏</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="control-btn haptic-feedback" onclick="exportAccuracyData()">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="control-btn haptic-feedback" onclick="resetAccuracy()">üóëÔ∏è –°–±—Ä–æ—Å</button>
                    </div>
                </div>
            `;
        }

        function renderBaseHistory() {
            const container = document.getElementById('baseHistoryList');
            
            if (basePoints.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #666); padding: 20px;">–ù–µ—Ç –±–∞–∑–æ–≤—ã—Ö —Ç–æ—á–µ–∫</div>';
                return;
            }
            
            container.innerHTML = basePoints.map((point, index) => {
                const isActive = index === activeBaseIndex;
                const typeIcon = point.type === 'high' ? 'üìà' : 'üìâ';
                const typeName = point.type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ—á–∫–µ
                const pointResults = accuracyData.filter(r => r.basePointId === point.id && r.result !== 'pending');
                const pointHits = pointResults.filter(r => r.result === 'hit');
                const accuracyText = pointResults.length > 0 ? 
                    `${Math.round((pointHits.length / pointResults.length) * 100)}% (${pointHits.length}/${pointResults.length})` :
                    '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                return `
                    <div class="base-point-item ${isActive ? 'active' : ''}" onclick="switchToBase(${index})">
                        <div class="base-point-header">
                            <span class="base-point-type">${typeIcon}</span>
                            <span class="base-point-price">${point.price.toFixed(4)}</span>
                            ${isActive ? '<span style="color: var(--tg-theme-button-color, #3390ec); font-weight: bold;">–ê–ö–¢–ò–í–ù–ê–Ø</span>' : ''}
                        </div>
                        <div class="base-point-info">
                            <div>${typeName} ‚Ä¢ ${new Date(point.date).toLocaleDateString('ru-RU')}</div>
                            <div>–¢–æ—á–Ω–æ—Å—Ç—å: ${accuracyText}</div>
                            <div style="font-size: 0.8em; opacity: 0.7;">${point.description}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function switchToBase(index) {
            hapticFeedback('medium');
            
            if (index < 0 || index >= basePoints.length) return;
            
            activeBaseIndex = index;
            localStorage.setItem('activeBaseIndex', activeBaseIndex.toString());
            
            const base = basePoints[index];
            const now = new Date();
            const baseDate = new Date(base.date);
            
            console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –±–∞–∑–æ–≤—É—é —Ç–æ—á–∫—É:', base.id, base.price, base.date);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
            const baseResults = accuracyData.filter(r => r.basePointId === base.id && r.backtesting);
            console.log('–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏:', baseResults.length);
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–æ—á–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è - –∑–∞–ø—É—Å–∫–∞–µ–º backtesting
            if (baseResults.length === 0 && baseDate < now) {
                console.log('–ó–∞–ø—É—Å–∫–∞–µ–º backtesting –¥–ª—è —Ç–æ—á–∫–∏:', base.id);
                const backtestResults = runHistoricalBacktest(activeBaseIndex);
                
                if (backtestResults && backtestResults.length > 0) {
                    const hits = backtestResults.filter(r => r.result === 'hit').length;
                    const accuracy = Math.round((hits / backtestResults.length) * 100);
                    
                    console.log('Backtesting –∑–∞–≤–µ—Ä—à–µ–Ω:', hits, '/', backtestResults.length);
                    tg.showAlert(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω ${base.type === 'high' ? '–º–∞–∫—Å–∏–º—É–º' : '–º–∏–Ω–∏–º—É–º'} ${base.price.toFixed(4)}\nüß™ Backtesting: ${hits}/${backtestResults.length} (${accuracy}%)`);
                } else {
                    console.log('Backtesting –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                    tg.showAlert(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${base.type === 'high' ? '–º–∞–∫—Å–∏–º—É–º' : '–º–∏–Ω–∏–º—É–º'} ${base.price.toFixed(4)}\n‚ö†Ô∏è –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö`);
                }
            } else if (baseResults.length > 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const hits = baseResults.filter(r => r.result === 'hit').length;
                const accuracy = Math.round((hits / baseResults.length) * 100);
                
                console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', hits, '/', baseResults.length);
                tg.showAlert(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω ${base.type === 'high' ? '–º–∞–∫—Å–∏–º—É–º' : '–º–∏–Ω–∏–º—É–º'} ${base.price.toFixed(4)}\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${hits}/${baseResults.length} (${accuracy}%)`);
            } else {
                tg.showAlert(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${base.type === 'high' ? '–º–∞–∫—Å–∏–º—É–º' : '–º–∏–Ω–∏–º—É–º'} ${base.price.toFixed(4)}\nüìà –ë—É–¥—É—â–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã`);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
            updateActiveBaseInfo();
            renderCountdowns();
            updateTradingSignals();
            updateAccuracy();
            renderBaseHistory();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        function showNewBaseForm() {
            hapticFeedback('light');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newBaseDate').value = today;
            document.getElementById('newBasePrice').value = '';
            document.getElementById('newBaseDescription').value = '';
            
            document.getElementById('newBaseModal').style.display = 'block';
        }

        function hideNewBaseForm() {
            hapticFeedback('light');
            document.getElementById('newBaseModal').style.display = 'none';
        }

        function createNewBase() {
            hapticFeedback('medium');
            
            const price = parseFloat(document.getElementById('newBasePrice').value);
            const date = document.getElementById('newBaseDate').value;
            const description = document.getElementById('newBaseDescription').value || '–ù–æ–≤–∞—è —Ç–æ—á–∫–∞';
            const type = document.querySelector('input[name="baseType"]:checked').value;
            
            if (!price || !date || price < 0.8000 || price > 1.5000) {
                tg.showAlert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:\n‚Ä¢ –¶–µ–Ω–∞: –æ—Ç 0.8000 –¥–æ 1.5000\n‚Ä¢ –î–∞—Ç–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
                return;
            }
            
            const newBase = {
                id: Date.now(),
                type,
                price,
                date: new Date(date),
                description,
                created: new Date()
            };
            
            basePoints.push(newBase);
            activeBaseIndex = basePoints.length - 1;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            localStorage.setItem('gannBasePoints', JSON.stringify(basePoints));
            localStorage.setItem('activeBaseIndex', activeBaseIndex.toString());
            
            console.log('–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞:', newBase);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–æ—á–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º backtesting
            const now = new Date();
            const baseDate = new Date(date);
            
            if (baseDate < now) {
                // –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ - –∑–∞–ø—É—Å–∫–∞–µ–º backtesting
                console.log('–ó–∞–ø—É—Å–∫–∞–µ–º backtesting –¥–ª—è –Ω–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Ç–æ—á–∫–∏');
                const backtestResults = runHistoricalBacktest(activeBaseIndex);
                
                if (backtestResults && backtestResults.length > 0) {
                    const hits = backtestResults.filter(r => r.result === 'hit').length;
                    const accuracy = Math.round((hits / backtestResults.length) * 100);
                    
                    console.log('Backtesting —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', hits, '/', backtestResults.length, '=', accuracy + '%');
                    
                    tg.showAlert(`‚úÖ ${type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º'} ${price.toFixed(4)} —Å–æ–∑–¥–∞–Ω!\n\nüß™ Backtesting —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n‚Ä¢ –¢–µ—Å—Ç–æ–≤: ${backtestResults.length}\n‚Ä¢ –ü–æ–ø–∞–¥–∞–Ω–∏–π: ${hits}\n‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy}%`);
                } else {
                    console.log('Backtesting –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                    tg.showAlert(`‚úÖ ${type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º'} ${price.toFixed(4)} —Å–æ–∑–¥–∞–Ω!\n\n‚ö†Ô∏è –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è backtesting`);
                }
            } else {
                // –ë—É–¥—É—â–∞—è —Ç–æ—á–∫–∞
                console.log('–°–æ–∑–¥–∞–Ω–∞ –±—É–¥—É—â–∞—è —Ç–æ—á–∫–∞');
                tg.showAlert(`‚úÖ ${type === 'high' ? '–ú–∞–∫—Å–∏–º—É–º' : '–ú–∏–Ω–∏–º—É–º'} ${price.toFixed(4)} —Å–æ–∑–¥–∞–Ω!\n\nüìà –ë—É–¥—É—â–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—é`);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            hideNewBaseForm();
            updateActiveBaseInfo();
            renderCountdowns();
            updateTradingSignals();
            updateAccuracy();
            renderBaseHistory();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏
        function showPriceHistoryManager() {
            hapticFeedback('light');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('historyDate').value = today;
            document.getElementById('historyPrice').value = '';
            
            updateRecentHistoryList();
            document.getElementById('priceHistoryModal').style.display = 'block';
        }

        function hidePriceHistoryManager() {
            hapticFeedback('light');
            document.getElementById('priceHistoryModal').style.display = 'none';
        }

        function addHistoricalPrice() {
            hapticFeedback('medium');
            
            const date = document.getElementById('historyDate').value;
            const price = parseFloat(document.getElementById('historyPrice').value);
            
            if (!date || !price || price < 0.8000 || price > 1.5000) {
                tg.showAlert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:\n‚Ä¢ –î–∞—Ç–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞\n‚Ä¢ –¶–µ–Ω–∞: –æ—Ç 0.8000 –¥–æ 1.5000');
                return;
            }
            
            const dateKey = date;
            userHistoricalData[dateKey] = price;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('userHistoricalData', JSON.stringify(userHistoricalData));
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('historyPrice').value = '';
            const nextDate = new Date(date);
            nextDate.setDate(nextDate.getDate() + 1);
            document.getElementById('historyDate').value = nextDate.toISOString().split('T')[0];
            
            updateRecentHistoryList();
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backtesting –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
            const activeBase = basePoints[activeBaseIndex];
            if (activeBase && new Date(activeBase.date) < new Date()) {
                console.log('–û–±–Ω–æ–≤–ª—è–µ–º backtesting –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã...');
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
                accuracyData = accuracyData.filter(record => 
                    !(record.basePointId === activeBase.id && record.backtesting)
                );
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π backtesting
                const results = runHistoricalBacktest(activeBaseIndex);
                
                if (results && results.length > 0) {
                    renderCountdowns();
                    updateAccuracy();
                    
                    const hits = results.filter(r => r.result === 'hit').length;
                    const accuracy = Math.round((hits / results.length) * 100);
                    
                    tg.showAlert(`‚úÖ –¶–µ–Ω–∞ ${price.toFixed(4)} –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ ${new Date(date).toLocaleDateString('ru-R